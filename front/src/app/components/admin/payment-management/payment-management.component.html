<div class="page-container">
  <div class="header">
    <div>
      <h1>Gestion des paiements</h1>
      <p>Recherche et administration des paiements</p>
    </div>
    <button mat-raised-button color="primary" (click)="exportToCSV()">
      <mat-icon>download</mat-icon>
      Exporter
    </button>
  </div>

  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtres de recherche</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Étudiant</mat-label>
          <mat-select formControlName="studentId">
            <mat-option [value]="null">Tous</mat-option>
            <mat-option *ngFor="let student of students" [value]="student.id">
              {{student.firstName}} {{student.lastName}}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Groupe</mat-label>
          <mat-select formControlName="groupId">
            <mat-option [value]="null">Tous</mat-option>
            <mat-option *ngFor="let group of groups" [value]="group.id">{{group.name}}</mat-option>
          </mat-select>
          <mat-icon matPrefix>group</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Série</mat-label>
          <mat-select formControlName="sessionSeriesId">
            <mat-option [value]="null">Toutes</mat-option>
            <mat-option *ngFor="let serie of series" [value]="serie.id">{{serie.name}}</mat-option>
          </mat-select>
          <mat-icon matPrefix>event_note</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Statut</mat-label>
          <mat-select formControlName="active">
            <mat-option [value]="null">Tous</mat-option>
            <mat-option [value]="true">Actif</mat-option>
            <mat-option [value]="false">Inactif</mat-option>
          </mat-select>
          <mat-icon matPrefix>check_circle</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date début</mat-label>
          <input matInput [matDatepicker]="pickerStart" formControlName="dateFrom">
          <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
          <mat-icon matPrefix>date_range</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Niveau</mat-label>
          <mat-select formControlName="levelId">
            <mat-option [value]="null">Tous</mat-option>
            <mat-option *ngFor="let level of levels" [value]="level.id">{{level.name}}</mat-option>
          </mat-select>
          <mat-icon matPrefix>school</mat-icon>
        </mat-form-field>
      </form>

      <div class="filter-actions">
        <button mat-raised-button color="primary" type="button" (click)="loadPaymentDetails()">
          <mat-icon>search</mat-icon>
          <span>Rechercher</span>
        </button>
        <button mat-raised-button type="button" (click)="resetFilters()">
          <mat-icon>clear_all</mat-icon>
          <span>Effacer</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="table-card">
    <div class="table-header">
      <h2>Résultats</h2>
      <mat-chip [highlighted]="true">{{totalElements}} paiement(s)</mat-chip>
    </div>

    <div class="table-wrapper" *ngIf="!isLoading; else loading">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let element"> {{element.id}} </td>
        </ng-container>

        <ng-container matColumnDef="student">
          <th mat-header-cell *matHeaderCellDef> Étudiant </th>
          <td mat-cell *matCellDef="let element">
            <a [href]="'/student/' + element.studentId" target="_blank" class="table-link"
              matTooltip="Ouvrir la fiche étudiant">
              {{getStudentFullName(element)}}
              <mat-icon class="open-icon">open_in_new</mat-icon>
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="group">
          <th mat-header-cell *matHeaderCellDef> Groupe </th>
          <td mat-cell *matCellDef="let element">
            <a *ngIf="element.groupId" [href]="'/group/' + element.groupId" target="_blank" class="table-link"
              matTooltip="Ouvrir la fiche groupe">
              {{element.groupName}}
              <mat-icon class="open-icon">open_in_new</mat-icon>
            </a>
            <span *ngIf="!element.groupId">-</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="series">
          <th mat-header-cell *matHeaderCellDef> Série </th>
          <td mat-cell *matCellDef="let element"> {{element.seriesName || '-'}} </td>
        </ng-container>

        <ng-container matColumnDef="session">
          <th mat-header-cell *matHeaderCellDef> Session </th>
          <td mat-cell *matCellDef="let element">
            {{element.sessionName || '-'}}
          </td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef> Montant </th>
          <td mat-cell *matCellDef="let element">
            <strong>{{element.amountPaid | currency:'DZD':'symbol':'1.0-0'}}</strong>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Statut </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip [color]="getStatusColor(element)" [highlighted]="true">
              {{getStatusLabel(element)}}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="dateCreation">
          <th mat-header-cell *matHeaderCellDef> Créé le </th>
          <td mat-cell *matCellDef="let element">
            {{element.dateCreation | date:'dd/MM/yyyy HH:mm'}}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header"> Actions </th>
          <td mat-cell *matCellDef="let element" class="actions-cell">
            <button mat-icon-button color="primary" matTooltip="Modifier" (click)="openEditDialog(element)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="accent" matTooltip="Historique" (click)="openHistoryDialog(element)">
              <mat-icon>history</mat-icon>
            </button>
            <button *ngIf="element.active" mat-icon-button color="warn" matTooltip="Supprimer définitivement"
              (click)="deletePaymentDetail(element)">
              <mat-icon>cancel</mat-icon>
            </button>
            <button *ngIf="!element.active && !element.permanentlyDeleted" mat-icon-button color="success"
              matTooltip="Réactiver" (click)="reactivatePaymentDetail(element)">
              <mat-icon>check_circle</mat-icon>
            </button>
            <span *ngIf="!element.active && element.permanentlyDeleted" class="deleted-label">
              Supprimé définitivement
            </span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      <mat-paginator [length]="totalElements" [pageIndex]="pageIndex" [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 20, 50]" (page)="onPageChange($event)" showFirstLastButtons>
      </mat-paginator>
    </div>
    <ng-template #loading>
      <div class="loading">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
        <p>Chargement des paiements...</p>
      </div>
    </ng-template>
  </mat-card>
</div>